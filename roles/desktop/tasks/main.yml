---
- name: install the desktop environment
  pacman:
    name: gdm gnome

- name: prevent sleep at login screen
  shell: unset XDG_RUNTIME_DIR; dbus-launch gsettings set org.gnome.settings-daemon.plugins.power sleep-inactive-ac-type nothing

- name: screensaver does not activate
  lineinfile:
    path: /usr/share/glib-2.0/schemas/org.gnome.desktop.screensaver.gschema.xml
    insertafter: 'name="idle-activation-enabled"'
    firstmatch: yes
    regexp: '<default>'
    line: "      <default>false</default>"
  register: screensaver
    
- name: disable screen locking
  lineinfile:
    path: /usr/share/glib-2.0/schemas/org.gnome.desktop.screensaver.gschema.xml
    insertafter: 'name="lock-enabled"'
    firstmatch: yes
    regexp: '<default>'
    line: "      <default>false</default>"
  register: screenlocker

- name: disable screen idling
  lineinfile:
    path: /usr/share/glib-2.0/schemas/org.gnome.desktop.session.gschema.xml
    insertafter: 'name="idle-delay"'
    firstmatch: yes
    regexp: '<default>'
    line: "      <default>0</default>"
  register: screenidle

- name: disable machine sleeping
  lineinfile:
    path: /usr/share/glib-2.0/schemas/org.gnome.settings-daemon.plugins.power.gschema.xml
    insertafter: 'name="sleep-inactive-ac-timeout"'
    firstmatch: yes
    regexp: '<default>'
    line: "      <default>0</default>"
  register: sleep

- name: compile schemas
  command: glib-compile-schemas .
  args:
    chdir: /usr/share/glib-2.0/schemas
  when: screensaver.changed or screenlocker.changed or screenidle.changed or sleep.changed

- name: make autologin group
  group:
    name: autologin
    system: yes
    state: present

- name: make nopasswdlogin group
  group:
    name: nopasswdlogin
    system: yes
    state: present

- name: Determine available users
  getent:
    database: passwd
  
- name: Check if accountsservice is installed
  command: pacman -Q accountsservice
  register: accountsservice_installed
  failed_when: no
  changed_when: no

- name: vagrant user not on login page
  blockinfile:
    path: /var/lib/AccountsService/users/vagrant
    mode: 600
    create: yes
    block: |
      [User]
      XSession=gnome
      SystemAccount=true
  when: "'vagrant' in getent_passwd" and accountsservice_installed.rc == 0   # only when the vagrant user exists and accountsservice is here

